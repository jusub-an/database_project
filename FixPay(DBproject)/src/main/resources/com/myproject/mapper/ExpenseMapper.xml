<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myproject.mapper.ExpenseMapper">
    
    <insert id="insertSelectKey">
		<selectKey keyProperty="expense_id" order="BEFORE" resultType="long">
			select seq_fixed_expense.nextval from dual
		</selectKey>

		insert into Fixed_Expense 
		(expense_id, name, amount, payment_day, user_id, 
		 category_id, cycle_id, method_id, is_active) -- 1. is_active 추가 (이전 수정)
		values 
		(#{expense_id}, #{name}, #{amount}, #{payment_day}, #{user_id}, 
		 #{category_id, jdbcType=NUMERIC},  -- 2. NUMERIC (or BIGINT)
		 #{cycle_id, jdbcType=NUMERIC},    -- 3. NUMERIC (or BIGINT)
		 #{method_id, jdbcType=NUMERIC},  -- 4. NUMERIC (or BIGINT)
		 1) -- 5. is_active 기본값 1
	</insert>
	
	<select id="read" resultType="com.myproject.domain.ExpenseVO">
	    SELECT 
	        e.expense_id, e.name, e.amount, e.payment_day, e.user_id,
	        e.category_id, e.method_id, e.cycle_id, e.is_active,
	        c.name as category_name,   m.name as method_name,     cy.name as cycle_name      FROM Fixed_Expense e
	    LEFT JOIN Category c ON e.category_id = c.category_id
	    LEFT JOIN Payment_Method m ON e.method_id = m.method_id
	    LEFT JOIN Payment_Cycle cy ON e.cycle_id = cy.cycle_id
	    WHERE e.expense_id = #{expense_id}
	    AND e.is_active = 1
	</select>
	
	<delete id="delete">
    DELETE FROM Fixed_Expense
    WHERE expense_id = #{expense_id}
	</delete>
	
	<update id="update">
	    update Fixed_Expense
	    set name = #{name},
	    amount = #{amount},
	    payment_day = #{payment_day},
	    category_id = #{category_id},
	    method_id = #{method_id},
	    cycle_id = #{cycle_id}
	    where expense_id = #{expense_id}
	</update>
	
	<select id="getListWithPaging" resultType="com.myproject.domain.ExpenseVO">
    <![CDATA[
    select 
        expense_id, name, amount, payment_day, 
        category_name, method_name,
        cycle_name  /* 1. 최종 SELECT에 cycle_name 추가 */
    from (    
        select /*+INDEX_DESC(Fixed_Expense pk_fixed_expense) */ 
            rownum rn, 
            e.expense_id, e.name, e.amount, e.payment_day,
            c.name as category_name,
            m.name as method_name,
            cy.name as cycle_name  /* 2. JOIN 결과 별명(cycle_name) 추가 */
        from Fixed_Expense e
        LEFT JOIN Category c ON e.category_id = c.category_id
        LEFT JOIN Payment_Method m ON e.method_id = m.method_id
        
        LEFT JOIN Payment_Cycle cy ON e.cycle_id = cy.cycle_id  /* 3. 'Cycle' -> 'Payment_Cycle'로 수정 */
        
        where e.user_id = #{user_id}
        AND e.is_active = 1
        AND rownum <= #{pageNum} * #{amount} 
    ) 
    where rn > (#{pageNum} -1) * #{amount} 
    ]]>
</select>
	
	<select id="getTotalCount" resultType="int">
		select count(*) from Fixed_Expense 
		where user_id = #{user_id}
		AND is_active = 1  -- [!!!] '활성' 상태인 것만
	</select>

	<select id="getCategoryStats" resultType="com.myproject.domain.StatsDTO">
    SELECT
        c.name as category_name,
        SUM(h.paid_amount) as total_amount
    FROM Payment_History h
    JOIN Fixed_Expense e ON h.expense_id = e.expense_id
    JOIN Category c ON e.category_id = c.category_id
    WHERE e.user_id = #{user_id}
    GROUP BY c.name
    ORDER BY total_amount DESC
	</select>
    
    <select id="getAllExpenses" resultType="com.myproject.domain.ExpenseVO">
	    SELECT
	        e.expense_id, e.name, e.amount, e.payment_day, e.category_id,
	        c.name as category_name
	    FROM Fixed_Expense e
	    LEFT JOIN Category c ON e.category_id = c.category_id
	    WHERE e.user_id = #{user_id}
	    AND e.is_active = 1  -- [!!!] '활성' 상태인 것만
	    ORDER BY e.payment_day
	</select>
	
	<select id="getUpcomingExpenses" resultType="com.myproject.domain.ExpenseVO">
    SELECT * FROM Fixed_Expense
    WHERE user_id = #{user_id}
    AND is_active = 1
    AND (
        <choose>
            <when test="startDay &lt;= endDay">
                payment_day BETWEEN #{startDay} AND #{endDay}
            </when>
            
            <otherwise>
                (payment_day >= #{startDay} OR payment_day &lt;= #{endDay})
            </otherwise>
        </choose>
    )
    ORDER BY payment_day ASC
	</select>
	
	<select id="getFilteredHistory" resultType="java.util.Map">
	    SELECT 
	        h.paid_amount as "AMOUNT",
	        TO_CHAR(h.payment_date, 'YYYY-MM') as "PAY_MONTH",
	        TO_CHAR(h.payment_date, 'YYYY-MM-DD') as "PAY_DATE",
	        e.name as "EXPENSE_NAME",
	        c.name as "CATEGORY_NAME",
	        m.name as "METHOD_NAME",
	        cy.name as "CYCLE_NAME"
	    FROM Payment_History h
	    JOIN Fixed_Expense e ON h.expense_id = e.expense_id
	    LEFT JOIN Category c ON e.category_id = c.category_id
	    LEFT JOIN Payment_Method m ON e.method_id = m.method_id
	    LEFT JOIN Payment_Cycle cy ON e.cycle_id = cy.cycle_id
	    WHERE e.user_id = #{user_id}
	    
	    <if test="categoryList != null and categoryList.size() > 0">
	        AND c.name IN
	        <foreach item="item" collection="categoryList" open="(" separator="," close=")">
	            #{item}
	        </foreach>
	    </if>
	    
	    <if test="methodList != null and methodList.size() > 0">
	        AND m.name IN
	        <foreach item="item" collection="methodList" open="(" separator="," close=")">
	            #{item}
	        </foreach>
	    </if>
	    
	    <if test="cycleList != null and cycleList.size() > 0">
	        AND cy.name IN
	        <foreach item="item" collection="cycleList" open="(" separator="," close=")">
	            #{item}
	        </foreach>
	    </if>
	    
	    ORDER BY h.payment_date ASC
	</select>
	
</mapper>